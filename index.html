<script>
/* ==== Global variables ==== */
var calloutEnabled = true;
var tooltipEnabled = true;
var currentHighlightColor = "#ffa500"; 
var mapColor = "#90EE90";
var mapLineColor = "#000000";

var map = L.map('map').setView([30.0, 70.0], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

var geojsonLayer = null;
var allLayers = [];
var cropData = null;
var pakprovince = null;
var activeCrops = new Set();

/* ==== UI controls ==== */
document.getElementById('toggle-callout').addEventListener('change', function() {
  calloutEnabled = this.checked;
  document.getElementById('info-box').style.display = calloutEnabled ? 'block' : 'none';
});

document.getElementById('toggle-tooltip').addEventListener('change', function() {
  tooltipEnabled = this.checked;
  allLayers.forEach(layer => {
    if (!tooltipEnabled && layer.getTooltip()) layer.unbindTooltip();
    else if (tooltipEnabled && !layer.getTooltip() && layer.feature.properties.shapeName) {
      layer.bindTooltip(layer.feature.properties.shapeName, { permanent: false });
    }
  });
});

document.getElementById('color-picker').addEventListener('input', function() {
  currentHighlightColor = this.value;
});

document.getElementById('color-picker-map-bgrd').addEventListener('input', function() {
  mapColor = this.value;
  if (geojsonLayer) geojsonLayer.setStyle(defaultStyle);
});

document.getElementById('color-picker-map-line').addEventListener('input', function() {
  mapLineColor = this.value;
  if (geojsonLayer) geojsonLayer.setStyle(defaultStyle);
});

document.getElementById('clear-btn').addEventListener('click', function() {
  clearHighlights();
});

/* ==== Load ADM3 GeoJSON ==== */
fetch('geoBoundaries-PAK-ADM3.geojson')
.then(r => r.json())
.then(data => {
  geojsonLayer = L.geoJSON(data, {
    style: defaultStyle,
    onEachFeature: function(feature, layer) {
      allLayers.push(layer);
      if (feature.properties && feature.properties.shapeName) {
        layer.bindTooltip(feature.properties.shapeName, {permanent: false});

        layer.on('mouseover', function() {
          if (calloutEnabled) showInfo(feature.properties.shapeName);
          if (tooltipEnabled) layer.openTooltip();
        });
        layer.on('mouseout', function() {
          if (calloutEnabled) clearInfo();
          if (tooltipEnabled) layer.closeTooltip();
        });
        layer.on('click', function() {
          toggleHighlight(layer);
          if (calloutEnabled) showInfo(feature.properties.shapeName);
        });
      }
    }
  }).addTo(map);

  map.fitBounds(geojsonLayer.getBounds());
  buildSidebar(data);

  /* ==== Load ADM1 Province Layer ==== */
  fetch('geoBoundaries-PAK-ADM1.geojson')
  .then(r => r.json())
  .then(data => {
    pakprovince = L.geoJSON(data, {
      style: {
        fillColor: 'transparent',
        fillOpacity: 0,
        color: "#000000",
        weight: 3,
        opacity: 1
      },
      interactive: false,
      onEachFeature: function(feature, layer) {
        if (feature.properties && feature.properties.name) {
          layer.bindTooltip(feature.properties.name);
        }
      }
    });

    document.getElementById('province-btn').addEventListener('change', function() {
      if (this.checked) {
        pakprovince.addTo(map);
        pakprovince.bringToBack();
      } else {
        if (pakprovince) map.removeLayer(pakprovince);
      }
    });
  }); // ADM1 fetch ends

}); // ADM3 fetch ends

/* ==== Styles ==== */
function defaultStyle(feature) {
  return {
    fillColor: feature._highlightColor || mapColor,
    color: mapLineColor,
    weight: feature._isHighlighted ? 2 : 1,
    fillOpacity: feature._isHighlighted ? 0.75 : 0.8
  };
}

/* ==== Info Box ==== */
function showInfo(name) { 
  document.getElementById('info-box').innerHTML = "<b>Selected Tehsil:</b> " + name; 
}
function clearInfo() { 
  document.getElementById('info-box').innerHTML = "Hover over a tehsil or click to see details here"; 
}

/* ==== Highlight Functions ==== */
function toggleHighlight(layer) {
  if (layer._isHighlighted) {
    layer._isHighlighted = false;
    delete layer._highlightColor;
    geojsonLayer.resetStyle(layer);
    if (!tooltipEnabled) layer.closeTooltip();
  } else {
    layer._isHighlighted = true;
    layer._highlightColor = currentHighlightColor;
    layer.setStyle({
      fillColor: layer._highlightColor,
      color: mapLineColor,
      weight: 3,
      fillOpacity: 0.75
    });
    layer.bringToFront();
    if (tooltipEnabled) layer.openTooltip();
  }
}

function clearHighlights() {
  geojsonLayer.eachLayer(layer => {
    layer._isHighlighted = false;
    delete layer._highlightColor;
    delete layer._highlightBy;
    geojsonLayer.resetStyle(layer);
  });
}

/* ==== Sidebar ==== */
function buildSidebar(data) {
  let sidebar = document.getElementById('sidebar');
  let groups = {};
  data.features.forEach(f => {
    if (f.properties && f.properties.shapeGroup && f.properties.shapeName) {
      let group = f.properties.shapeGroup;
      if (!groups[group]) groups[group] = [];
      groups[group].push(f);
    }
  });

  Object.keys(groups).sort().forEach(group => {
    let heading = document.createElement('h3');
    heading.textContent = group;
    sidebar.appendChild(heading);

    groups[group].sort((a,b) => a.properties.shapeName.localeCompare(b.properties.shapeName))
      .forEach(f => {
        let div = document.createElement('div');
        div.className = 'district-item';
        div.textContent = f.properties.shapeName;
        div.onclick = () => { 
          highlightDistrict(f.properties.shapeName); 
          if(calloutEnabled) showInfo(f.properties.shapeName); 
        };
        sidebar.appendChild(div);
      });
  });
}

function highlightDistrict(name) {
  geojsonLayer.eachLayer(layer => {
    if (layer.feature.properties.shapeName === name) toggleHighlight(layer);
  });
}

/* ==== Crop Highlights ==== */
function getCropColor(cropName) {
  let input = document.getElementById("color-" + cropName);
  return input ? input.value : "#ffa500";
}

function highlightCrop(cropName) {
  if (!cropData || !cropData[cropName]) return;

  Object.values(cropData[cropName]).forEach(provinceObj => {
    Object.values(provinceObj).forEach(districtList => {
      districtList.forEach(districtName => {
        geojsonLayer.eachLayer(layer => {
          if (layer.feature.properties.shapeName &&
              layer.feature.properties.shapeName.toLowerCase() === districtName.toLowerCase()) {

            layer._highlightBy = layer._highlightBy || {};
            layer._highlightBy[cropName] = getCropColor(cropName);

            let lastColor = Object.values(layer._highlightBy).slice(-1)[0];
            layer._isHighlighted = true;
            layer._highlightColor = lastColor;
            layer.setStyle({ fillColor: lastColor, color: mapLineColor, weight: 2, fillOpacity:0.75 });
            layer.bringToFront();
          }
        });
      });
    });
  });
}

function removeCropHighlight(cropName) {
  if (!cropData || !cropData[cropName]) return;

  Object.values(cropData[cropName]).forEach(provinceObj => {
    Object.values(provinceObj).forEach(districtList => {
      districtList.forEach(districtName => {
        geojsonLayer.eachLayer(layer => {
          if (layer.feature.properties.shapeName &&
              layer.feature.properties.shapeName.toLowerCase() === districtName.toLowerCase()) {

            if (layer._highlightBy) delete layer._highlightBy[cropName];

            if (layer._highlightBy && Object.keys(layer._highlightBy).length > 0) {
              let lastColor = Object.values(layer._highlightBy).slice(-1)[0];
              layer._highlightColor = lastColor;
              layer.setStyle({ fillColor: lastColor, color: mapLineColor, weight:2, fillOpacity:0.75 });
            } else {
              layer._isHighlighted = false;
              delete layer._highlightColor;
              geojsonLayer.resetStyle(layer);
            }
          }
        });
      });
    });
  });
}

function toggleCrop(cropName) {
  if (!cropData) return;
  if (activeCrops.has(cropName)) {
    removeCropHighlight(cropName);
    activeCrops.delete(cropName);
  } else {
    highlightCrop(cropName);
    activeCrops.add(cropName);
  }

  if (activeCrops.size === 0) clearHighlights();
}

/* ==== Crop Buttons ==== */
document.getElementById('btn1').addEventListener('click', () => toggleCrop("cotton"));
document.getElementById('btn2').addEventListener('click', () => toggleCrop("rice"));
document.getElementById('btn3').addEventListener('click', () => toggleCrop("sesame_seed"));
document.getElementById('btn4').addEventListener('click', () => toggleCrop("wheat"));

</script>
