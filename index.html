<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Pakistan Tehsils Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<link rel="icon" href="data:,">
<style>
  html, body { height: 100%; margin: 0; padding: 0; }
  body { display: flex; font-family: Arial, sans-serif; }
  #sidebar { width: 15%; background: #f8f9fa; overflow-y: auto; padding: 10px; border-right: 1px solid #ccc; }
  #map { flex: 1; height: 100%; position: relative; }
  #info-box { position: absolute; top: 10px; left: 30%; transform: translateX(-50%);
              z-index: 1000; padding: 8px 15px; background: rgba(255,255,255,0.95);
              border: 1px solid #333; border-radius: 5px; font-weight: bold;
              pointer-events: none; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: block; }
  h3 { margin: 10px 0 5px 0; font-size: 16px; color: #222; cursor: default; }
  .district-item { cursor: pointer; padding: 5px; margin: 2px 0; border-radius: 5px; padding-left: 15px; }
  .district-item:hover { background-color: #e0e0e0; }
  .toggle-container { margin-bottom: 10px; }
  button { display:block; margin-top: 5px; }
</style>
</head>
<body>

<div id="sidebar">
  <div class="toggle-container">
    <input type="checkbox" id="toggle-callout" checked>
    <label for="toggle-callout">Show Callout</label>
  </div>

  <div class="toggle-container">
    <input type="checkbox" id="toggle-tooltip" checked>
    <label for="toggle-tooltip">Show Hover Tooltip</label>
  </div>

  <div class="toggle-container">
    <input type="checkbox" id="province-btn">
    <label for="province-btn">Show Province</label>
  </div>

  <div class="toggle-container">
    <label for="color-picker">Select Dist Highlight Color:</label><br>
    <input type="color" id="color-picker" value="#ffa500" style="width:50%; margin-top:10px;">
  </div>

  <div class="toggle-container">
    <label for="color-picker-map-bgrd">Select Map Fill Color:</label><br>
    <input type="color" id="color-picker-map-bgrd" value="#90EE90" style="width:50%; margin-top:5px;">
  </div>

  <div class="toggle-container">
    <label for="color-picker-map-line">Select Map Line Color:</label><br>
    <input type="color" id="color-picker-map-line" value="#000000" style="width:50%; margin-top:5px;">
  </div>

  <div class="toggle-container">
    <button id="clear-btn" style="width:50%; background:#f08080;">Clear Selection</button>
  </div>

  <div class="toggle-container">
  <div style="display:flex; align-items:center; margin-bottom:5px;">
    <button id="btn1" style="flex:1;">Cotton</button>
    <input type="color" id="color-cotton" value="#ffa500" style="margin-left:5px; width:30px; height:30px;">
  </div>
  <div style="display:flex; align-items:center; margin-bottom:5px;">
    <button id="btn2" style="flex:1;">Rice</button>
    <input type="color" id="color-rice" value="#90EE90" style="margin-left:5px; width:30px; height:30px;">
  </div>
  <div style="display:flex; align-items:center; margin-bottom:5px;">
    <button id="btn3" style="flex:1;">Sesame</button>
    <input type="color" id="color-sesame_seed" value="#87CEEB" style="margin-left:5px; width:30px; height:30px;">
  </div>
  <div style="display:flex; align-items:center; margin-bottom:5px;">
    <button id="btn4" style="flex:1;">Wheat</button>
    <input type="color" id="color-wheat" value="#F08080" style="margin-left:5px; width:30px; height:30px;">
  </div>
 </div>
</div>

<div id="map">
  <div id="info-box">Hover over a tehsil or click to see details here</div>
</div>

<script>
/* ==== Global variables ==== */
var calloutEnabled = true;
var tooltipEnabled = true;
var currentHighlightColor = "#ffa500"; // default
var mapColor = "#90EE90";
var mapLineColor = "#000000";

var map = L.map('map').setView([30.0, 70.0], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

var geojsonLayer = null;
var allLayers = [];
var cropData = null;
var pakprovince = null; // declare globally
// Add this line:
var activeCrops = new Set();  // <-- track multiple active crops
let activeCrop = null; // track which crop is active

/* ==== UI controls ==== */
document.getElementById('toggle-callout').addEventListener('change', function() {
  calloutEnabled = this.checked;
  document.getElementById('info-box').style.display = calloutEnabled ? 'block' : 'none';
});

document.getElementById('toggle-tooltip').addEventListener('change', function() {
  tooltipEnabled = this.checked;
  if (!tooltipEnabled) {
    allLayers.forEach(layer => {
      if (layer.getTooltip()) {
        layer.unbindTooltip(); // completely remove the tooltip
      }
    });
  } else {
    allLayers.forEach(layer => {
      if (!layer.getTooltip() && layer.feature.properties.shapeName) {
        layer.bindTooltip(layer.feature.properties.shapeName, { permanent: false });
      }
    });
  }
});

// Province Button 
document.getElementById('province-btn').addEventListener('change', function() {
  if (this.checked) {
    if (pakprovince) pakprovince.addTo(map);  // fixed variable name
  } else {
    if (pakprovince) map.removeLayer(pakprovince);
  }
});

document.getElementById('color-picker').addEventListener('input', function() {
  currentHighlightColor = this.value;
});

document.getElementById('color-picker-map-bgrd').addEventListener('input', function() {
  mapColor = this.value;
  if (geojsonLayer) geojsonLayer.setStyle(defaultStyle);
});

document.getElementById('color-picker-map-line').addEventListener('input', function() {
  mapLineColor = this.value;
  if (geojsonLayer) geojsonLayer.setStyle(defaultStyle);
});

// Clear button -> reset all selections
document.getElementById('clear-btn').addEventListener('click', function() {
  geojsonLayer.eachLayer(layer => {
    layer._isHighlighted = false;
    geojsonLayer.resetStyle(layer);
  });
});

  
/* ==== Styles ==== */
function defaultStyle(feature) {
  return {
    fillColor: feature._highlightColor || mapColor,
    color: mapLineColor,
    weight: feature._isHighlighted ? 2 : 1,
    fillOpacity: feature._isHighlighted ? 0.75 : 0.8
  };
}

/* ==== Info box ==== */
function showInfo(name) {
  document.getElementById('info-box').innerHTML = "<b>Selected Tehsil:</b> " + name;
}
function clearInfo() {
  document.getElementById('info-box').innerHTML = "Hover over a tehsil or click to see details here";
}

/* ==== Toggle highlight ==== */
function toggleHighlight(layer) {
  if (layer._isHighlighted) {
    layer._isHighlighted = false;
    delete layer._highlightColor;
    geojsonLayer.resetStyle(layer);
    if (!tooltipEnabled) layer.closeTooltip();
  } else {
    layer._isHighlighted = true;
    layer._highlightColor = currentHighlightColor;
    layer.setStyle({
      fillColor: layer._highlightColor,
      color: mapLineColor,
      weight: 3,       // slightly thicker border
      fillOpacity: 0.75
    });
    layer.bringToFront();  // <-- ensures highlight appears above all layers
    if (tooltipEnabled) layer.openTooltip();
  }
}
/* ==== Load GeoJSON ==== */
fetch('geoBoundaries-PAK-ADM3.geojson')
.then(r => r.json())
.then(data => {
  geojsonLayer = L.geoJSON(data, {
    style: defaultStyle,
    onEachFeature: function(feature, layer) {
      allLayers.push(layer);
      if (feature.properties && feature.properties.shapeName) {
        layer.bindTooltip(feature.properties.shapeName, {permanent: false});

       layer.on('mouseover', function() {
        console.log(
          "Mouseover:", feature.properties.shapeName, 
          "tooltipEnabled =", tooltipEnabled,
          "hasTooltip =", !!layer.getTooltip()
        );
         if (calloutEnabled) {
          showInfo(feature.properties.shapeName);
          }
        if (tooltipEnabled) {
          console.log("âž¡ï¸ Opening tooltip for", feature.properties.shapeName);
          layer.openTooltip();
        } else {
          console.log("âŒ Tooltip disabled, should NOT open");
        }
      });

        layer.on('mouseout', function() {
          console.log("Mouseover:", feature.properties.shapeName, "tooltipEnabled =", tooltipEnabled);
          if (calloutEnabled) clearInfo();
          if (tooltipEnabled) layer.closeTooltip();
        });
        layer.on('click', function() {
          toggleHighlight(layer);
          if (calloutEnabled) showInfo(feature.properties.shapeName);
        });
      }
    }
  }).addTo(map);

  map.fitBounds(geojsonLayer.getBounds());
  buildSidebar(data);

// ==== Load Province Map ====
fetch('pak_boundry.geojson')
  .then(r => r.json())
  .then(data => {
    pakprovince = L.geoJSON(data, {
      style: {
        fillOpacity: 0,       // no fill
        color: "#000000",     // black border
        weight: 3,            // thick line
        opacity: 1             // fully visible
      },
      onEachFeature: function(feature, layer) {
        if (feature.properties && feature.properties.name) {
          layer.bindTooltip(feature.properties.name);
        }
      }
    });
  });


  
  // ==== Load Crop Data ====
 fetch('crops.json')
  .then(r => r.json())
  .then(data => {
    cropData = data;
    console.log("âœ… Crop data loaded", cropData);
  })
  .catch(err => console.error("âŒ Error loading crop data:", err));
  
});

/* ==== Sidebar ==== */
function buildSidebar(data) {
  let sidebar = document.getElementById('sidebar');
  let groups = {};
  data.features.forEach(f => {
    if (f.properties && f.properties.shapeGroup && f.properties.shapeName) {
      let group = f.properties.shapeGroup;
      if (!groups[group]) groups[group] = [];
      groups[group].push(f);
    }
  });

  Object.keys(groups).sort().forEach(group => {
    let heading = document.createElement('h3');
    heading.textContent = group;
    sidebar.appendChild(heading);

    groups[group].sort((a,b) => a.properties.shapeName.localeCompare(b.properties.shapeName))
      .forEach(f => {
        let div = document.createElement('div');
        div.className = 'district-item';
        div.textContent = f.properties.shapeName;
        div.onclick = () => { highlightDistrict(f.properties.shapeName); if(calloutEnabled) showInfo(f.properties.shapeName); };
        sidebar.appendChild(div);
      });
  });
}

function highlightDistrict(name) {
  geojsonLayer.eachLayer(layer => {
    if (layer.feature.properties.shapeName === name) toggleHighlight(layer);
  });
}

// ==== Highlight Crop ====
function highlightCrop(cropName) {
  if (!cropData || !cropData[cropName]) {
    console.warn("âš ï¸ Crop not found:", cropName);
    return;
  }

  // Reset previous highlights
  geojsonLayer.eachLayer(layer => {
    layer._isHighlighted = false;
    delete layer._highlightColor;
    geojsonLayer.resetStyle(layer);
  });

  // Iterate crop divisions and districts
  Object.values(cropData[cropName]).forEach(provinceObj => {
    Object.values(provinceObj).forEach(districtList => {
      districtList.forEach(districtName => {
        geojsonLayer.eachLayer(layer => {
          if (layer.feature.properties.shapeName &&
              layer.feature.properties.shapeName.toLowerCase() === districtName.toLowerCase()) {
            
            layer._isHighlighted = true;
            layer._highlightColor = currentHighlightColor;
            layer.setStyle({
              fillColor: layer._highlightColor,
              color: mapLineColor,
              weight: 2,
              fillOpacity: 0.75
            });
          }
        });
      });
    });
  });

  console.log("ðŸŒ¾ Highlighted crop:", cropName);
}



 function clearHighlights() {
  geojsonLayer.eachLayer(layer => {
    layer._isHighlighted = false;
    delete layer._highlightColor;
    geojsonLayer.resetStyle(layer); // back to default
  });
}


  function toggleCrop(cropName) {
  if (activeCrops.has(cropName)) {
    // Crop is already active â†’ remove its highlight
    removeCropHighlight(cropName);
    activeCrops.delete(cropName);
    console.log("âŒ Removed highlights for", cropName);
  } else {
    // Add this crop
    highlightCrop(cropName);
    activeCrops.add(cropName);
    console.log("âœ… Highlighted", cropName);
  }
}
function removeCropHighlight(cropName) {
  if (!cropData || !cropData[cropName]) return;

  Object.values(cropData[cropName]).forEach(provinceObj => {
    Object.values(provinceObj).forEach(districtList => {
      districtList.forEach(districtName => {
        geojsonLayer.eachLayer(layer => {
          if (layer.feature.properties.shapeName &&
              layer.feature.properties.shapeName.toLowerCase() === districtName.toLowerCase()) {

            // Check if this district is part of **other active crops**
            let stillActive = false;
            activeCrops.forEach(otherCrop => {
              if (otherCrop !== cropName && cropData[otherCrop]) {
                Object.values(cropData[otherCrop]).forEach(provObj => {
                  Object.values(provObj).forEach(dList => {
                    if (dList.some(d => d.toLowerCase() === districtName.toLowerCase())) {
                      stillActive = true;
                    }
                  });
                });
              }
            });

            if (!stillActive) {
              layer._isHighlighted = false;
              delete layer._highlightColor;
              geojsonLayer.resetStyle(layer);
            }
          }
        });
      });
    });
  });
}


function getCropColor(cropName) {
  let inputId = "color-" + cropName;
  let input = document.getElementById(inputId);
  return input ? input.value : "#ffa500"; // fallback color
}

// Update highlightCrop to use this color
function highlightCrop(cropName) {
  if (!cropData || !cropData[cropName]) return;

  Object.values(cropData[cropName]).forEach(provinceObj => {
    Object.values(provinceObj).forEach(districtList => {
      districtList.forEach(districtName => {
        geojsonLayer.eachLayer(layer => {
          if (layer.feature.properties.shapeName &&
              layer.feature.properties.shapeName.toLowerCase() === districtName.toLowerCase()) {

            layer._isHighlighted = true;
            layer._highlightColor = getCropColor(cropName);
            layer.setStyle({
              fillColor: layer._highlightColor,
              color: mapLineColor,
              weight: 2,
              fillOpacity: 0.75
            });
          }
        });
      });
    });
  });

  console.log("ðŸŒ¾ Highlighted crop:", cropName);
}
  
  // Button event bindings
  document.getElementById('btn1').addEventListener('click', function() { toggleCrop("cotton");  });
  document.getElementById('btn2').addEventListener('click', function() { toggleCrop("rice");  });
  document.getElementById('btn3').addEventListener('click', function() { toggleCrop("sesame_seed");  });
  document.getElementById('btn4').addEventListener('click', function() { toggleCrop("wheat");  });

</script>
</body>
</html>
















